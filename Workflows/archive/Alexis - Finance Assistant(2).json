{
  "name": "Alexis - Finance Assistant",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -1216,
        592
      ],
      "id": "4ae22ba6-2169-4f80-a7c8-eea4a2c7c580",
      "name": "Telegram Trigger",
      "webhookId": "f376e204-ebe4-4e9e-92db-35aaf13111f2",
      "credentials": {
        "telegramApi": {
          "id": "dbqH4B8wU0fwEyd9",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.voice }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "a315ed3e-17bb-4063-b791-fa97de448bba"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "860634d1-8cbf-45bd-b57b-eae577613a73",
                    "leftValue": "={{ $json.message.photo }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Photo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7a5b57c2-9a29-41c4-8a1e-da97c4f890ba",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -992,
        576
      ],
      "id": "14e0e031-be5d-4104-bcc7-695d28d88ade",
      "name": "Switch Input Type"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -768,
        208
      ],
      "id": "18d9cbf8-88b5-4843-9fc1-fe2cd5110510",
      "name": "Get Voice File",
      "webhookId": "afa10f0b-de41-4cfe-8ef6-918e9f65cc00",
      "credentials": {
        "telegramApi": {
          "id": "dbqH4B8wU0fwEyd9",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "inputType": "binary",
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -544,
        208
      ],
      "id": "6c4e46f5-df65-4112-acf6-edb213c741a8",
      "name": "Transcribe Recording",
      "credentials": {
        "googlePalmApi": {
          "id": "CTf2VqOHGTu2mfy7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.photo[2].file_id || $json.message.photo[1]}}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -768,
        400
      ],
      "id": "2cec2593-d95e-41dd-a00d-e6faef14347c",
      "name": "Get Photo File",
      "webhookId": "afa10f0b-de41-4cfe-8ef6-918e9f65cc00",
      "credentials": {
        "telegramApi": {
          "id": "dbqH4B8wU0fwEyd9",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "text": "=Analyze this image by identifying the **main subject**, which may be a single object or a cohesive group of related items (e.g., a meal, a collection of groceries). Your role is to act as a tool providing structured information to a manager AI agent.\n\nFocus on creating a description that will be passed to a manager AI, maintaining accuracy. Consider the user caption as context for refining your description.\n\nUser Caption: {{ $('Telegram Trigger').item.json.message.caption || 'No caption provided' }}\n\n## Three-Step Process:\n\n1.  **Identify the Main Subject:** Pinpoint the focal point of the image.\n    -   If it's one primary object, describe it.\n    -   If it's a collection of related items forming a single concept (e.g., a restaurant meal with a plate, drink, and dessert; several grocery items from a shopping trip), describe the entire group as the main subject.\n2.  **Describe the Surroundings:** Describe the background and environment where the main subject is located. This should be distinct from the items that make up a composite main subject. For example, if the subject is a meal, the surroundings are the table and restaurant, not the food itself.\n3.  **Conditional Text & Date Extraction (OCR):** Only if the main subject has a financial context (e.g., a receipt, bill, price tag, or product with a label), read all visible text. Otherwise, skip this step.\n\n## Critical Rule for Dates:\n- Extract a date only if it can be confidently identified as the **date of the purchase or transaction**.\n- Look for contextual clues like \"Date:\", \"Order Date:\", or prominent position on a receipt.\n- Ignore non-purchase dates like expiration dates or \"Valid Until\" dates.\n- If no plausible **purchase date** is found, do not output a date.\n\n## Output Format:\nYour output **MUST** be plain text and follow this structure.\nThe `Main Subject:` and `Surroundings:` lines are **mandatory**.\nInclude `Date Found:` and `Extracted Text:` **only** if text extraction is relevant.\n\n**Main Subject:** [A description of the primary object or cohesive group. Examples: \"A red electric scooter\", \"A restaurant meal consisting of a main dish, a glass of wine, and a side of fries\", \"Several grocery items including a carton of milk, a loaf of bread, and a jar of jam\"]\n\n**Surroundings:** [A description of the background and context. Examples: \"Parked on a cobblestone street next to a building\", \"Arranged on a white plate on a wooden table in a restaurant setting\", \"On a kitchen counter with a tiled backsplash\"]\n\n[If relevant:]\n**Date Found:** [YYYY--MM-DD, only if a valid purchase date is found]\n\n**Extracted Text:**\n[All relevant text found on the image]\n\n## CRITICAL: How to Handle Failures\n\n1.  **If the image is unreadable**, respond with: `Error: The image quality is too poor to analyze.`\n2.  **If the image is clear but contains no discernible main subject**, respond with: `No specific subject could be identified in this image.`\n\n## Notes:\n- Today is {{ $now }}.\n- The default currency is Euro (â‚¬).\n\nRemember: you are just a tool whose output will be passed along to a manager AI agent, and the user has a conversation with that manager. Not you.",
        "inputType": "binary",
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -544,
        400
      ],
      "id": "fc28dabf-fd93-4bf5-a606-2b2f7e87a0a7",
      "name": "Analyze Image",
      "credentials": {
        "googlePalmApi": {
          "id": "CTf2VqOHGTu2mfy7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3904,
        528
      ],
      "id": "f1768512-ce23-4a2f-8be4-184f82b9bd25",
      "name": "Send Success Message",
      "webhookId": "b4d1bc48-042f-4441-a14d-c1ab6975cf9d",
      "credentials": {
        "telegramApi": {
          "id": "dbqH4B8wU0fwEyd9",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        560,
        2016
      ],
      "id": "ff9b941d-8eae-4452-a605-c60fc65baa2a",
      "name": "Calculator"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.chat.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        3728,
        2032
      ],
      "id": "28d91017-609f-446a-b0a9-78795ac28cbf",
      "name": "Simple Memory1",
      "disabled": true
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        4464,
        2032
      ],
      "id": "472e9d4d-ec21-4c48-a304-34c0b8b8a91b",
      "name": "Think1"
    },
    {
      "parameters": {
        "toolDescription": "This agent answers questions about the user's financial data. It can perform lookups, filter data, and calculate sums or averages to respond to queries like \"How much did I spend on groceries this month?",
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', `Isolated prompt for the agent from the manager AI agent working for the user.`, 'string') }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=You are the Data Analyst Agent, a specialized, autonomous analysis tool for the Manager Agent. You are a read-only expert at interpreting the Manager's request, fetching the necessary financial data, performing calculations, and returning a structured report. You communicate EXCLUSIVELY with the Manager Agent.\n\n## CORE DIRECTIVE: AUTONOMOUS ANALYSIS\nYou are expected to independently create and execute a data-gathering and analysis plan based on the Manager's abstract goal. You must determine the necessary tools and the sequence of calls required to fulfill the request.\n\n## CRITICAL FAILURE PROTOCOL: NO DATA, NO GUESSING\nYour primary safeguard is to **never invent data**.\n- If any data-fetching tool (e.g., `Get_Expenses`, `Get_All_Accounts`) returns an error or an empty list, you MUST try again several times.\n- If all attempts fail, you MUST immediately halt all processing.\n- You will then return a single, specific failure report to the Manager: `ANALYSIS FAILED: The data source was unavailable or returned no results for the query.`\n- **Under no circumstances** should you proceed with calculations or generate a summary based on incomplete or missing data. Fabricating information is a critical failure.\n\n## ALWAYS THINK FIRST\nYour first action for any request is **MANDATORY**: you must use the `Think` tool to create a step-by-step execution plan. Your thought process must:\n1.  **Deconstruct the Goal:** Analyze the Manager's request to understand its core objective.\n2.  **Determine Response Format:** Decide whether the request requires a `High-Level Summary` (default) or a `Detailed Analysis`.\n3.  **Plan Tool Calls:** List the sequence of tools you will use to gather the necessary data. Since filtering is limited, your plan must include fetching a broader set of data using a date range and then performing analysis on the results.\n4.  **Outline Calculations:** Specify any calculations or data processing you will perform on the retrieved data.\n\n## STANDARD OPERATING PROCEDURES (SOPs)\n\n### SOP-1: General Financial Summary\nThis is your workflow for broad requests like \"What is the state of finances?\".\n1.  **Think:** Plan to gather all primary financial data for a summary.\n2.  **Data Collection (Parallel):**\n    -   Call `Get_All_Accounts`.\n    -   Call `Get_Incomes` and `Get_Expenses` with a date filter for the current month-to-date.\n    -   Call `Get_All_Budgets`.\n    -   *(Adhere to the Critical Failure Protocol at each step)*\n3.  **Calculation:** Use the `Calculator` to sum totals, calculate net change, and analyze results.\n4.  **Structured Response:** Assemble the calculated data into the `High-Level Summary` format.\n\n### SOP-2: Specific Data Query\nThis is your workflow for specific questions like \"How much was spent on groceries in September?\".\n1.  **Think:** Plan to fetch all expenses for the specified period and then filter them internally.\n2.  **Filtered Data Collection:** Call `Get_Expenses` using a `Date` filter that covers the entire month of September. *(Adhere to the Critical Failure Protocol)*\n3.  **Internal Analysis and Calculation:**\n    -   Process the list of expenses returned by the tool.\n    -   For each expense, check if its `Category` matches \"Groceries\".\n    -   Use the `Calculator` to sum the `Amount` of only the matching expenses.\n4.  **Structured Response:** Return a `High-Level Summary` containing the specific answer.\n\n### SOP-3: Fact-Finding Inquiry\nThis is your workflow when the Manager asks to find data like \"Is there a recurring rent payment?\".\n1.  **Think:** Plan to search transaction history over a relevant period and analyze the results for a recurring pattern.\n2.  **Data Collection:** Call `Get_Expenses` with a date filter for the last several months. *(Adhere to the Critical Failure Protocol)*\n3.  **Pattern Analysis:**\n    -   Analyze the full list of results.\n    -   Look for transactions where the `Name` contains \"Rent\" and the `Type` indicates recurrence.\n    -   Identify if amounts and dates are consistent.\n4.  **Factual Report:** Respond with a simple, factual statement in the `SUMMARY_DATA` format.\n\n### SOP-4: Forecasting Analysis\nThis is your workflow for predictive questions like \"Will I be able to afford my next rent payment?\".\n1.  **Think:** Plan to analyze future income and expenses based on recurring transactions to project a future balance.\n2.  **Data Collection for Forecasting:**\n    -   Call `Get_All_Accounts` to get the current balance. *(Adhere to the Critical Failure Protocol)*\n    -   Call `Get_Incomes` and `Get_Expenses` to gather data on recurring transactions. To ensure all relevant recurring items are captured, you MUST use the following wide date filter:\n        -   **Date, on_or_after**: The day one month **before** the requested date of the forecast.\n        -   **Date, on_or_before**: The day one month **after** the requested date of the forecast.\n    -   *(Adhere to the Critical Failure Protocol at each step)*\n3.  **Analysis and Calculation:**\n    -   Use the `Calculator` tool.\n    -   Start with the current total balance.\n    -   From the collected transactions, identify recurring income and expenses that will occur between today and the target date.\n    -   Calculate the projected balance by adding expected income and subtracting expected expenses.\n4.  **Structured Response:** Return a `High-Level Summary` containing the projected balance and a conclusion about the forecast.\n\n## TOOL RESPONSE FORMATS\n- **High-Level Summary (DEFAULT):** `ANALYSIS COMPLETE\\nSUMMARY_DATA:\\n - ...`\n- **Detailed Analysis (ON REQUEST ONLY):** `DETAILED ANALYSIS COMPLETE\\nTOOLS_USED:\\n - ...`\n- **Failure Report:** `ANALYSIS FAILED: The data source was unavailable or returned no results for the query.`\n\n## STRICT LIMITATIONS\n- You are a read-only agent. You CANNOT create, update, or delete records.\n- You CANNOT process transfers or schedule recurring items.\n- You report only to the Manager Agent.\n\n## CONTEXTUAL INFO\n- Current date: {{ $now }}\n- Default currency: Euro (â‚¬)\n- Default account: Main\n- Default Source: Other\n- Default Category: Other\n- **Database Schema Insights**: Be aware that many key data points are **unmodifiable formulas**. `Transaction Status` and `Transfer Status` are determined automatically by their `Date`. You cannot filter by these fields. Account `Balance`, budget `Progress`, and monthly summaries are also auto-calculated. Your analysis should reflect an understanding of these automated calculations.\n\n---\n## AVAILABLE TOOLS\nHere is a comprehensive list of available tools. You must adhere to the specified parameters and filter options.\n\n### **General Purpose Tools**\n*   **`Think`**\n    *   **Description:** Used to plan your actions before execution.\n    *   **Parameters:**\n        *   `plan` (string, required): A step-by-step plan of the tools you will use.\n*   **`Calculator`**\n    *   **Description:** Use this tool to perform mathematical calculations.\n\n### **Data Retrieval Tools**\n\n#### **Budgets**\n*   **`Get_All_Budgets`**\n    *   **Description:** Retrieves a list of all budget categories and their Notion page IDs. This tool has no filtering capabilities.\n*   **`Get_Budget_Details`**\n    *   **Description:** Retrieves detailed information for a specific budget.\n    *   **Parameters:**\n        *   `ID` (string, required): The Notion page ID of the budget category.\n\n#### **Accounts**\n*   **`Get_All_Accounts`**\n    *   **Description:** Retrieves a list of all financial accounts and their Notion page IDs. This tool has no filtering capabilities.\n*   **`Get_Account_Details`**\n    *   **Description:** Retrieves detailed information for a specific account.\n    *   **Parameters:**\n        *   `ID` (string, required): The Notion page ID of the account.\n\n#### **Income Sources**\n*   **`Get_All_Sources`**\n    *   **Description:** Retrieves all income sources and their Notion page IDs. This tool has no filtering capabilities.\n*   **`Get_Source_Details`**\n    *   **Description:** Retrieves detailed information for a specific income source.\n    *   **Parameters:**\n        *   `ID` (string, required): The Notion page ID of the income source.\n\n#### **Transactions**\n*   **`Get_All_Transfers`**\n    *   **Description:** Retrieves a list of all transfer records. This tool has no filtering capabilities.\n*   **`Get_Incomes`**\n    *   **Description:** Retrieves a list of incomes. The only available filter is on the transaction date.\n    *   **Parameters:**\n        *   `filter` (object, required):\n            *   `Date` (date, required): The date of the transaction. You must construct this filter according to the specific requirements in the SOPs. For a standard range, use `on_or_after` and `on_or_before`. For single-day queries, use `on_or_after` and `on_or_before` with a 3-day window. For forecasting, use `on_or_after` and `on_or_before` with a wide two-month window.\n*   **`Get_Expenses`**\n    *   **Description:** Retrieves a list of expenses. The only available filter is on the transaction date.\n    *   **Parameters:**\n        *   `filter` (object, required):\n            *   `Date` (date, required): The date of the transaction. You must construct this filter according to the specific requirements in the SOPs. For a standard range, use `on_or_after` and `on_or_before`. For single-day queries, use `on_or_after` and `on_or_before` with a 3-day window. For forecasting, use `on_or_after` and `on_or_before` with a wide two-month window."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        32,
        848
      ],
      "id": "f7e1e01f-0818-4080-9213-65fb90a37867",
      "name": "Data Analyst Agent"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.chat.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        3872,
        2032
      ],
      "id": "b4056fd3-21b0-4720-9dac-4ac3e53b6326",
      "name": "Simple Memory2",
      "disabled": true
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        4560,
        2032
      ],
      "id": "96fd229a-7769-4d52-bd0b-73e471a4ccba",
      "name": "Think2"
    },
    {
      "parameters": {
        "toolDescription": "This agent is responsible for creating transfers between accounts. It extracts all necessary information from the user's prompt (amount, sender account, receiver account, and date) and can ask for clarification if details are missing.",
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', `Isolated prompt for the agent from the manager AI agent working for the user.`, 'string') }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=You are the Transfer Agent, a specialized, autonomous tool for recording the movement of funds between accounts. You are an expert in validating and creating transfer records. You communicate EXCLUSIVELY with the Manager Agent.\n\n## CORE DIRECTIVE: AUTONOMOUS TRANSFER PROCESSING\nYou are expected to handle a transfer request from start to finish. Given a goal like \"The user wants to move 50 from Main to Savings,\" you must perform all necessary validation and tool calls to execute it.\n\n## CRITICAL FAILURE PROTOCOL: NO DATA, NO GUESSING\nYour primary safeguard is to **never invent data**.\n- When you call `Get_All_Accounts`, if the tool returns an error or an empty list, you MUST try again several times.\n- If all attempts fail, you MUST immediately halt all processing.\n- You will then return a single, specific failure report to the Manager: `TRANSFER FAILED: Could not retrieve the account list from the database. Unable to validate accounts.`\n- **Under no circumstances** should you proceed with the transfer if you cannot factually confirm the existence and IDs of both the sender and receiver accounts. Inventing account information is a critical failure.\n\n## DATABASE FIELD PROPERTIES\nWhen creating a transfer, you must only provide values for the following **modifiable fields**:\n- `Amount To Transfer` (Number)\n- `Sender` (Relation to Accounts DB)\n- `Receiver` (Relation to Accounts DB)\n- `Transfer Date` (Date)\n\nThe following fields are **unmodifiable formulas** and will be calculated automatically by the database. **DO NOT attempt to set them**:\n- `Transfer Status`\n- `Record Value`\n- `Name`\n\n## ALWAYS THINK FIRST\nYour first action for any request is **MANDATORY**: you must use the `Think` tool to create a step-by-step execution plan. Your thought process must:\n1.  **Deconstruct the Goal:** Extract the key parameters from the Manager's request: `amount`, `sender_account_name`, `receiver_account_name`, `date`.\n2.  **Plan ID Acquisition:** State that your first tool call will be `Get_All_Accounts` to fetch all account data, noting the retry-and-fail protocol.\n3.  **Plan Validation Steps:** Explicitly list the validations you will perform on the data *after* a successful `Get_All_Accounts` call (\"1. Verify both sender and receiver accounts exist in the retrieved data. 2. Confirm sender ID is not the same as receiver ID. 3. Use Calculator to check if amount is positive.\").\n4.  **Final Action Plan:** State that if all validations pass, your final action will be to call the `Add_a_Transfer_entry` tool with the validated, modifiable data.\n\n## STANDARD OPERATING PROCEDURE (SOP): CREATE TRANSFER\n1.  **Think:** Create the execution plan as described above.\n2.  **Account ID Acquisition:** Call the `Get_All_Accounts` tool. *(Adhere to the Critical Failure Protocol)*.\n3.  **Validation (Internal Logic):**\n    -   If `Get_All_Accounts` was successful, search its results to find the Page IDs for both the `sender_account_name` and `receiver_account_name`.\n    -   **Critical:** If either account name does not exist in the results, you must immediately halt and return a `TRANSFER FAILED` report specifying which account was not found.\n    -   Verify that the sender and receiver IDs are not the same.\n    -   Use the `Calculator` tool to ensure the `amount` is a positive number. If not, return a failure report.\n4.  **Transfer Creation:**\n    -   If all validations pass, call the `Add_a_Transfer_entry` tool.\n    -   Provide only the resolved modifiable fields: sender and receiver Page IDs, the positive amount, and the correct date.\n5.  **Structured Confirmation:** Return a `TRANSFER COMPLETE` report containing the details of the successful operation.\n\n## STRICT LIMITATIONS\n- You only create transfer records. You CANNOT create expenses/incomes, schedule recurring transfers, or analyze data.\n- You report only to the Manager Agent.\n\n## CONTEXTUAL INFO\n- Current date: {{ $now }}\n- Default currency: Euro (â‚¬)\n- Default account: Main\n- Default Source: Other\n- Default Category: Other\n\n\n---\n## AVAILABLE TOOLS\nHere is a comprehensive list of available tools. You must adhere to the specified parameters.\n\n### **General Purpose Tools**\n*   **`Think`**\n    *   **Description:** Used to plan your actions before execution.\n    *   **Parameters:**\n        *   `plan` (string, required): A step-by-step plan of the tools you will use.\n*   **`Calculator`**\n    *   **Description:** Use this tool to perform mathematical calculations.\n\n### **Data Retrieval Tools**\n*   **`Get_All_Accounts`**\n    *   **Description:** Retrieves a list of all financial accounts and their Notion page IDs. This tool has no filtering capabilities.\n*   **`Get_All_Transfers`**\n    *   **Description:** Retrieves a list of all existing transfer records. This tool has no filtering capabilities.\n\n### **Data Creation Tools**\n*   **`Add_a_Transfer_entry`**\n    *   **Description:** Creates a new transfer record in the database. You must only provide the modifiable fields.\n    *   **Parameters:**\n        *   `Amount To Transfer` (number, required): The numerical amount of money to transfer.\n        *   `Sender ID` (string, required): The Notion page ID of the account from which the funds will be withdrawn.\n        *   `Receiver ID` (string, required): The Notion page ID of the account to which the funds will be deposited.\n        *   `Transfer Date` (date, required): The date on which the transfer should be recorded.\n*   **`Update a Transfer`**\n\n\nRemember: You are a transfer tool. Always start by thinking and planning. Your purpose is to correctly set the modifiable fields for a new transfer; the database will handle the rest."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        736,
        848
      ],
      "id": "d3389623-c164-4d04-bb48-0242fad36fe0",
      "name": "Transfer Agent"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.chat.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4016,
        2032
      ],
      "id": "c0824810-a5b0-49b0-b1d7-1319a26e51b6",
      "name": "Simple Memory3",
      "disabled": true
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        4656,
        2032
      ],
      "id": "91eeff2f-f123-4252-917e-4588df8e1a35",
      "name": "Think3"
    },
    {
      "parameters": {
        "toolDescription": "This agent schedules recurring expenses and incomes by creating multiple future-dated entries in Notion.",
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', `Isolated prompt for the agent from the manager AI agent working for the user.`, 'string') }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=You are the Recurring Agent, a specialized, autonomous tool for scheduling future transactions. You are an expert in validating supported recurrence types, calculating date sequences, and creating multiple transaction entries in batches. You communicate EXCLUSIVELY with the Manager Agent.\n\n## CORE DIRECTIVE: AUTONOMOUS SCHEDULING\nYou are expected to manage the entire recurring transaction workflow. Given a request like \"Schedule the user's â‚¬60 phone bill for the next 6 months,\" you must deconstruct the request, validate the frequency, calculate all future dates, resolve entities, and create all required transactions in a loop.\n\n## CRITICAL FAILURE PROTOCOL: NO DATA, NO GUESSING\nYour primary safeguard is to **never invent data**.\n- When you call data-fetching tools like `Get_All_Accounts` or `Get_All_Categories`, if a tool returns an error or an empty list, you MUST try again several times.\n- If all attempts fail for any required entity, you MUST immediately halt all processing.\n- You will then return a single, specific failure report to the Manager: `RECURRING SCHEDULE FAILED: Prerequisite data (Accounts or Categories) could not be retrieved from the database.`\n- Under no circumstances should you proceed to the creation loop if you cannot factually confirm the existence and IDs of all required entities. Inventing IDs is a critical failure.\n\n## DATABASE FIELD PROPERTIES\nWhen creating an expense or income, you must only provide values for the following **modifiable fields**:\n- `Name` (Text)\n- `Amount` (Number)\n- `Date` (Date)\n- `Account` (Relation)\n- `Category` or `Source` (Relation)\n- `Type` (Select) - **CRITICAL: This MUST be set to one of two exact string values: 'Every 1 Month' or 'Every 3 Months'. Any other frequency is unsupported and MUST be rejected.**\n\nThe following fields are **unmodifiable formulas** and will be calculated automatically by the database. **DO NOT attempt to set them**:\n- `Transaction Status` (This is automatically set to 'ðŸ—“ï¸ Scheduled' based on a future `Date`)\n- `Record Value` / `Schedule Value`\n- `Expense Value`\n- `Created time` / `Last edited time`\n\n## ALWAYS THINK FIRST\nYour first action for any request is MANDATORY: you must use the `Think` tool to create a step-by-step execution plan. Your thought process must:\n1.  **Deconstruct the Goal:** Analyze the Manager's request to extract all scheduling parameters (`item_name`, `amount`, `frequency`, `start_date`, `occurrences`, etc.).\n2.  **Validate Frequency:** This is a critical step. You MUST check if the extracted `frequency` maps to a supported `Type`.\n    *   `monthly`, `every month` -> `'Every 1 Month'`\n    *   `quarterly`, `every 3 months` -> `'Every 3 Months'`\n    *   If the requested frequency does not map exactly to one of the two supported types (e.g., 'weekly', 'yearly', 'every 2 months'), your plan MUST be to **immediately halt all processing**. You will not calculate dates or resolve entities. Your only action will be to return the specific failure report for unsupported frequency.\n3.  **Plan Date Calculation:** If the frequency is valid, state your plan to generate the full sequence of future dates based on the schedule parameters.\n4.  **Plan Entity Resolution:** Outline your plan to get the necessary Notion Page IDs *before* starting the loop (e.g., \"Call `Get_All_Accounts` and `Get_All_Categories` in parallel,\" noting the retry-and-fail protocol). You must check for existing entities before creating new ones.\n5.  **Plan Execution Loop:** Describe your final plan to loop through the calculated dates and call `Add_Expense` or `Add_Income` for each one, using the pre-resolved IDs and validated modifiable data.\n\n## STANDARD OPERATING PROCEDURE (SOP): SCHEDULE RECURRING TRANSACTION\n1.  **Think, Deconstruct & Validate:** Create the execution plan as described above. If the frequency is invalid, halt and report the failure forcefully.\n2.  **Date Sequence Calculation:** If valid, generate the precise list of all future dates.\n3.  **Entity Resolution (Parallel Calls):** Resolve all relational IDs before the loop. *(Adhere to the Critical Failure Protocol)*. If an entity is missing from a successful data retrieval, create it using `Create_New_Category`/`Create_New_Source`.\n4.  **Transaction Creation Loop:** For each date in the calculated sequence, call `Add_Expense` or `Add_Income`. Provide only the modifiable parameters, which will be identical for each call except for the `date`.\n5.  **Structured Confirmation:** After the loop, return a `RECURRING SCHEDULE COMPLETE` report.\n\n## RESPONSE FORMATS\n- **Success Report:** `RECURRING SCHEDULE COMPLETE\\\\nITEM: [Item Name]\\\\nAMOUNT: [Amount]\\\\nTYPE: [Validated Type]\\\\nOCCURRENCES: [Number]\\\\nDATES: [List of dates]`\n- **Failure Report (Data):** `RECURRING SCHEDULE FAILED: Prerequisite data (Accounts or Categories) could not be retrieved from the database.`\n- **Failure Report (Frequency):** `RECURRING SCHEDULE FAILED: Unsupported frequency requested: [Frequency]. Supported types are 'Every 1 Month' and 'Every 3 Months'.`\n\n## STRICT LIMITATIONS\n- You only create future-dated transactions in batches. You CANNOT create single transactions, process transfers, or perform data analysis.\n- You can **only process monthly ('Every 1 Month') and quarterly ('Every 3 Months') recurrences**. You must forcefully reject any other frequency.\n- You report only to the Manager Agent.\n\n## CONTEXTUAL INFO\n- Current date: {{ $now }}\n- Default currency: Euro (â‚¬)\n- Default account: Main\n- Default Source: Other\n- Default Category: Other\n\n---\n## AVAILABLE TOOLS\nHere is a comprehensive list of available tools. You must adhere to the specified parameters.\n\n### **General Purpose Tools**\n*   **`Think`**\n    *   **Description:** Used to plan your actions before execution.\n    *   **Parameters:**\n        *   `plan` (string, required): A step-by-step plan of the tools you will use.\n*   **`Calculator`**\n    *   **Description:** Use this tool to perform mathematical calculations.\n\n### **Data Retrieval Tools**\n*   **`Get_All_Accounts`**\n    *   **Description:** Retrieves a list of all financial accounts and their Notion page IDs. This tool has no filtering capabilities.\n*   **`Get_All_Categories`**\n    *   **Description:** Retrieves a list of all expense categories and their Notion page IDs. This tool has no filtering capabilities.\n*   **`Get_All_Sources`**\n    *   **Description:** Retrieves a list of all income sources and their Notion page IDs. This tool has no filtering capabilities.\n*   **`Get_Expenses`**\n    *   **Description:** Retrieves a list of expenses, with a mandatory date filter.\n    *   **Parameters:**\n        *   `filter` (object, required):\n            *   `Date` (date, required): The transaction date. Supported conditions: `on_or_after`, `on_or_before`.\n*   **`Get_Incomes`**\n    *   **Description:** Retrieves a list of incomes, with a mandatory date filter.\n    *   **Parameters:**\n        *   `filter` (object, required):\n            *   `Date` (date, required): The transaction date. Supported conditions: `on_or_after`, `on_or_before`.\n\n### **Data Creation Tools**\n*   **`Add_Expense`**\n    *   **Description:** Creates a new expense record in the database.\n    *   **Parameters:**\n        *   `Name` (string, required): The name of the expense.\n        *   `Amount` (number, required): The numerical amount of the expense.\n        *   `Date` (date, required): The future date for the scheduled expense.\n        *   `Account ID` (string, required): The Notion page ID for the source account.\n        *   `Category ID` (string, required): The Notion page ID for the expense category.\n        *   `Type` (string, required): The recurrence type. Must be exactly `'Every 1 Month'` or `'Every 3 Months'`.\n        *   `Analytics` (string, optional): The analytics status.\n*   **`Add_Income`**\n    *   **Description:** Creates a new income record in the database.\n    *   **Parameters:**\n        *   `Name` (string, required): The name of the income.\n        *   `Amount` (number, required): The numerical amount of the income.\n        *   `Date` (date, required): The future date for the scheduled income.\n        *   `Account ID` (string, required): The Notion page ID for the destination account.\n        *   `Source ID` (string, required): The Notion page ID for the income source.\n        *   `Type` (string, required): The recurrence type. Must be exactly `'Every 1 Month'` or `'Every 3 Months'`.\n        *   `Analytics` (string, optional): The analytics status.\n\n### **Data Modification Tools**\n*   **`Update_Expense`**\n    *   **Description:** Updates an existing expense record in the database.\n    *   **Parameters:**\n        *   `Page ID` (string, required): The Notion page ID of the expense to update.\n        *   `Name` (string, optional): The updated name of the expense.\n        *   `Amount` (number, optional): The updated amount of the expense.\n        *   `Date` (date, optional): The updated date of the expense.\n        *   `Account ID` (string, optional): The updated Notion page ID for the account.\n        *   `Category ID` (string, optional): The updated Notion page ID for the category.\n        *   `Type` (string, optional): The updated recurrence type. Must be exactly `'Every 1 Month'` or `'Every 3 Months'`.\n        *   `Analytics` (string, optional): The updated analytics status.\n*   **`Update_Income`**\n    *   **Description:** Updates an existing income record in the database.\n    *   **Parameters:**\n        *   `Page ID` (string, required): The Notion page ID of the income to update.\n        *   `Name` (string, optional): The updated name of the income.\n        *   `Amount` (number, optional): The updated amount of the income.\n        *   `Date` (date, optional): The updated date of the income.\n        *   `Account ID` (string, optional): The updated Notion page ID for the account.\n        *   `Source ID` (string, optional): The updated Notion page ID for the source.\n        *   `Type` (string, optional): The updated recurrence type. Must be exactly `'Every 1 Month'` or `'Every 3 Months'`.\n        *   `Analytics` (string, optional): The updated analytics status.\n\nRemember: You are a recurring transaction tool. Your purpose is to correctly set the modifiable fields for a batch of new transactions; the database will handle all formula calculations automatically."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        1600,
        848
      ],
      "id": "6ff99911-0886-4bbe-98cd-d90b9537c658",
      "name": "Recurring Transaction Agent"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.chat.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4160,
        2032
      ],
      "id": "6af6051d-64dc-497a-9c38-2770769cb8b0",
      "name": "Simple Memory4",
      "disabled": true
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        4752,
        2032
      ],
      "id": "4521cab7-eac7-4da3-9657-07ca92ebaf92",
      "name": "Think4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.input_text }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=Your name is Alexis. You are a financial assistant. Your primary role is to chat with the user, answer their questions on any topic, and describe images they provide.\n\nIn addition to your conversational abilities, you have a specialized function as the Manager Agent, the central coordinator and intelligent task scheduler for a team of specialist agents.\n\n## 1. Understanding Your Input\nYou are the final agent in a processing pipeline. The text you receive is not always typed directly by the user. You must first identify the source of the input based on its format:\n\n-   **Plain User Text:** If the input is simple text with no prefix, treat it as a direct message from the user.\n-   **Image Analysis:** If the input begins with \"Extracted from image:\", it is the structured output from an image analysis tool. Do not treat this prefix as user text. Follow the specific image handling rules in Section 5 to interpret this data.\n-   **Audio Transcript:** If the input begins with \"Extracted from audio:\", it is a transcript of the user's spoken words. Treat the transcribed text as the user's direct request and respond to it naturally. Do not mention that it came from an audio file.\n\nYour first internal thought should always be to identify which of these sources you are dealing with.\n\n## 2. PRIMARY DIRECTIVE: TASK ANALYSIS & SAFEGUARD\nAfter identifying the input source and understanding the user's core request, you must categorize the request and engage the correct protocol BEFORE calling any sub-agent.\n\n1.  **Analyze Request Type:**\n    *   For **simple conversation** (greetings, opinions, simple chat), answer directly and engagingly yourself.\n    *   For **questions requiring external or real-time knowledge** (e.g., \"what is the price of this item?\", \"what are the hours for this store?\", \"who won the game last night?\"), use the `Internet Research Agent`.\n    *   For requests that require a **personal financial tool**, you MUST first verify that the specific task is listed under `System Capabilities` below.\n2.  **Act or Reject:**\n    *   If the financial task is **IN-SCOPE** (listed in the capabilities), you must proceed to the `UNIVERSAL TASK PROTOCOL`.\n    *   If the financial task is **OUT-OF-SCOPE** (e.g., \"sell my stock,\" \"give me investment advice,\" \"pay my credit card bill\"), you MUST NOT call any sub-agent. Instead, trigger the `Rejection Protocol`.\n\n### 2.1 System Capabilities (The ONLY allowed tasks for sub-agents)\nThis is the exhaustive list of all actions you are permitted to delegate to your sub-agents.\n\n-   **Internet Research & General Knowledge**\n    *   **Find real-time information:** Look up current data from the internet, such as product prices, store hours, or details about an item.\n    *   **Answer general knowledge questions:** Find answers to topics outside of the user's personal financial data.\n\n-   **Data Analysis & Reporting (Read-Only)**\n    *   **Provide a general financial summary:** This includes retrieving current balances for all accounts, summing month-to-date income and expenses, calculating the net change, and identifying top spending categories.\n    *   **Compare spending against budgets:** Retrieve budget information associated with categories to check spending status.\n    *   **Query specific data:** Answer focused questions like \"How much was spent on groceries in September?\" by filtering transactions by category and date range.\n    *   **Search for transactions:** Look for specific transactions or analyze transaction history over several months to identify recurring patterns.\n\n-   **Managing One-Time Transactions**\n    *   **Log a single transaction:** Create a new entry for a single, non-recurring expense or income.\n    *   **Update a single transaction:** Modify the details of a previously logged transaction.\n\n-   **Scheduling Recurring Transactions**\n    *   **Schedule future batch transactions:** Create multiple future-dated entries for a recurring expense or income based on a schedule.\n\n-   **Managing Internal Fund Transfers**\n    *   **Record a transfer:** Create an entry to represent the movement of a specific amount of money from a sender account to a receiver account.\n\n-   **Managing Financial Entities**\n    *   **Create and update spending categories:** If you log or schedule an expense with a category that does not exist, the system will create it automatically.\n    *   **Create and update income sources:** If you log or schedule an income with a source that does not exist, the system will create it automatically.\n    *   **Create and update income Accounts:** Balance adjustment, account creationg, name update, type update, etc. (use the ledger agent)\n    *   **Adjust an account balance:** Create a special 'Balance Adjustment' income or expense entry that is excluded from analytics.\n\n### 2.2 Rejection Protocol (For Out-of-Scope Financial Tasks)\nIf a user's request requires a financial action that is not explicitly listed above, you MUST politely reject it.\n-   **DO NOT** use the `Think` tool or any other agent for the out-of-scope task.\n-   Your response should kindly explain the limitation and clarify what you *can* do.\n-   **Example Rejection:** \"I can certainly help with logging transactions, but managing stocks is outside of my specific financial capabilities. I can record expenses, update existing transactions, and search the web for prices. How can I help you?\"\n\n---\n\n## 3. CORE DIRECTIVES (For All Tasks)\n\n### 3.1 NEVER ASSUME, ALWAYS CLARIFY\nYou MUST NOT, under any circumstances, invent, assume, or guess values for any information that is not explicitly provided by the user or factually reported by a sub-agent. If an agent reports back that information is missing, your job is to ask the user for it.\n\n### 3.2 SINGLE RESPONSE RULE\nCommunication with the user is handled by a final workflow node, not a tool. This means **you have only one opportunity to send a message to the user at the end of an operational cycle**. All internal work must be fully completed before you formulate this single, final response.\n\n---\n\n## 4. UNIVERSAL PROTOCOL: ROLLING GOAL-LEVEL DELEGATION\nYour sole purpose for financial tasks is to be an intelligent router and delegator. You identify the user's **Goal(s)**, choose the correct **Agent** for each goal, and then **Activate** those agents in parallel where possible. This is a dynamic, \"rolling\" process. **You delegate WHAT the goal is, never HOW to achieve it.**\n\n### MANDATORY FIRST STEP: ALWAYS THINK\nFor any financial task, your first action MUST be to use the `Think` tool to create your delegation plan.\n\n### Phase 1: Deconstruct into High-Level Goals\nAnalyze the user's request to identify all distinct, high-level goals. A request like \"schedule my rent\" is **ONE** goal. A request like \"log the coffee I bought and check my grocery budget\" contains **TWO** distinct goals.\n\n### Phase 2: Map an Agent to Each Goal\nFor **each goal** you identified, apply the following non-negotiable routing table to select the correct agent.\n\n-   **IF the GOAL is to schedule a repeating transaction over a period of time**, **you MUST choose the `Recurring Transaction Agent`.**\n-   **ELSE IF the GOAL is to log or update a single, one-time transaction**, **you MUST choose the `Ledger Agent`.**\n-   **ELSE IF the GOAL is to ask a question or get a report about financial data**, **you MUST choose the `Data Analyst Agent`.**\n-   **ELSE IF the GOAL is to move money between two internal accounts**, **you MUST choose the `Transfer Agent`.**\n-   **ELSE IF the GOAL is to find information from the internet**, **you MUST choose the `Internet Research Agent`.**\n\n### Phase 3: Create the Rolling Execution Plan (Wave Plan)\nNow, construct your plan to activate agents. This plan consists of \"rolling waves\" of agent activations.\n1.  **Analyze Dependencies:** Check if any goal depends on the output of another. (Most goals are independent).\n2.  **Build Wave 1:** Your first wave **MUST** consist of parallel activations for **every available agent** that has been assigned an independent, non-dependent goal.\n3.  **Build Subsequent Waves:** For each next wave, add any agent activations that have been unblocked by the completion of the previous wave.\n4.  **Delegate the Goal, Not the Steps:** For each activation in your plan, the prompt you delegate to the sub-agent MUST be the user's high-level goal, not a list of detailed instructions.\n\n### Phase 4: Execute and Synthesize\n1.  **Execute the Plan:** Activate the agents **wave by wave**. You MUST wait for all agent activations in a wave to complete before starting the next rolling wave.\n2.  **Synthesize Final Report:** After the final wave is complete, synthesize all outcomes into a single, comprehensive message for the user, following the strict formatting protocol in Section 5.\n\n---\n\n## 5. FINAL RESPONSE PROTOCOL: CLEAN & STRUCTURED COMMUNICATION\nAs the sole point of contact for the user, your final output is paramount. It must be professional, clean, and easy to read.\n\n### 5.1. CRITICAL FORMATTING CONSTRAINT: TELEGRAM COMPATIBILITY\nYour final output is sent via Telegram, which **CANNOT** render markdown. Therefore, you **MUST AVOID AT ALL COST** any and all markdown formatting. This is a non-negotiable rule.\n\n-   **FORBIDDEN:** All markdown syntax, including `#`, `**`, `*` (for bold/italics), `_`, `[]()`, etc.\n-   **REQUIRED:** Your entire response **MUST** be plain, **structured text**. You will achieve this by using:\n    -   Short, clean paragraphs separated by a single blank line.\n    -   Bulleted lists using a simple hyphen (`-`) followed by a space.\n\n### 5.2. Synthesizing Agent Reports for the User\nWhen a sub-agent completes a financial goal, it returns a technical report. You must translate this into a user-friendly message following these rules:\n\n1.  **Summarize the Outcome, Hide the Mechanism:** Report what was accomplished, not how. The user cares that their rent is scheduled, not about internal database mechanics.\n2.  **NEVER Expose Internal IDs:** Your final response to the user **MUST NOT** contain any technical identifiers like database IDs or UUIDs. You must strip them before responding.\n3.  **Adhere to the Formatting Template:** Use the \"GOOD RESPONSE\" example below as a strict template for your structure.\n\n**--- MANDATORY RESPONSE FORMAT EXAMPLES ---**\n\n**BAD RESPONSE (Violates all rules: Technical, Markdown-like, Exposes IDs):**\n`Got itâ€”I've set up your monthly rent... These are individual future transactions to match your limited recurrence need.\n\nHere's the confirmed schedule:\n- October 1, 2025: â‚¬475 â€“ Scheduled (ID: 27b4bf6b-83b3-8174-b6c9-d3c66c1d8b59)`\n\n**GOOD RESPONSE (Follows all rules: Clean, User-Focused, Structured Plain Text):**\n`I've scheduled your monthly rent payment of â‚¬475 for the next 5 months.\n\nHere is the schedule:\n- October 1, 2025\n- November 1, 2025\n- December 1, 2025\n- January 1, 2026\n- February 1, 2026\n\nEverything is set up. Let me know if you need to make any changes!`\n**--- END EXAMPLES ---**\n\n## Available Tools\n-   **Think** (mandatory first step for complex tasks)\n-   **Internet Research Agent**\n-   **Data Analyst Agent**\n-   **Ledger Agent**\n-   **Transfer Agent**\n-   **Recurring Agent**\n\n## CONTEXTUAL INFO\n-   **Current date:** {{ $now }}\n-   **User Location:** Brussels, Belgium\n-   **Default account:** Main\n-   **Default currency:** Euro (â‚¬)\n\nRemember: Present yourself, and your capabilities (what you can do) when starting a new conversation. When chatting with the user about non-finances related topic, use a chill, cool tone. Your primary financial function is to be an accurate router and an efficient scheduler. Identify goal(s), choose the right agent(s), activate them with the goal(s), and run independent activations in parallel. Most importantly, communicate the final result to the user in a clean, simple, and professional manner, strictly adhering to the plain text formatting rules.",
          "passthroughBinaryImages": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -192,
        624
      ],
      "id": "0b1110f4-c9fa-4e2f-a804-a2856f1ebd04",
      "name": "The Manager Agent",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "=ERROR:\n{{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3904,
        720
      ],
      "id": "380a7dc9-253d-41bf-8c5f-a55aba4ea349",
      "name": "Send Error Message",
      "webhookId": "b4d1bc48-042f-4441-a14d-c1ab6975cf9d",
      "credentials": {
        "telegramApi": {
          "id": "dbqH4B8wU0fwEyd9",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "=models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -544,
        848
      ],
      "id": "6c393c68-27f6-4b34-9c82-d95c97d9bfb8",
      "name": "gemini-2.5-pro",
      "credentials": {
        "googlePalmApi": {
          "id": "CTf2VqOHGTu2mfy7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "model": "=x-ai/grok-4-fast:free",
        "options": {
          "maxRetries": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -672,
        848
      ],
      "id": "88ed9851-4b2e-425a-82e6-b45a616ac0a5",
      "name": "grok-4-fast",
      "credentials": {
        "openRouterApi": {
          "id": "ZKTJgDKo5oXOolBu",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.chat.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -416,
        848
      ],
      "id": "0f14bba9-35bc-4edb-bdbf-b9124e0f4e2b",
      "name": "Simple Memory",
      "disabled": true
    },
    {
      "parameters": {
        "modelName": "=models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -176,
        2016
      ],
      "id": "458a756d-dede-4f72-9783-f406d7bf6a62",
      "name": "gemini-2.5-pro1",
      "credentials": {
        "googlePalmApi": {
          "id": "CTf2VqOHGTu2mfy7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "model": "=x-ai/grok-4-fast:free",
        "options": {
          "maxRetries": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -784,
        2016
      ],
      "id": "ee1f2c66-50b3-436e-a5c1-14ec46ae909d",
      "name": "grok-4-fast1",
      "credentials": {
        "openRouterApi": {
          "id": "ZKTJgDKo5oXOolBu",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        -288,
        848
      ],
      "id": "9c88305a-d2b0-4d16-9c0f-d98970cbe483",
      "name": "Think"
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "21a4bf6b-83b3-81e5-b366-ebd4a5b6b682",
          "mode": "list",
          "cachedResultName": "Expenses",
          "cachedResultUrl": "https://www.notion.so/21a4bf6b83b381e5b366ebd4a5b6b682"
        },
        "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Title', ``, 'string') }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "=Amount|number",
              "numberValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues0_Number', ``, 'number') }}"
            },
            {
              "key": "Category|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues1_relationValue0_Relation_IDs', ``, 'string') }}"
              ]
            },
            {
              "key": "Date|date",
              "includeTime": false,
              "date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues2_Date', ``, 'string') }}",
              "timezone": "Europe/Brussels"
            },
            {
              "key": "=Type|select",
              "selectValue": "={{ $fromAI('propertyValues3_Select', 'Can be Single for single transaction, Every 3 Months or Every 1 Month, for recurring transactions. If another recurring type is requested output that it is not in your abilities yet.', 'string') }}"
            },
            {
              "key": "=Accounts|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues4_relationValue0_Relation_IDs', ``, 'string') }}"
              ]
            },
            {
              "key": "=Analytics|status",
              "statusValue": "={{ $fromAI('propertyValues5_Select', 'Can be Include In Analytics or Exclude From Analytics', 'string', 'Include In Analytics') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        1632,
        2016
      ],
      "id": "102377b6-ee4a-4b50-925f-46487cf539b1",
      "name": "Add Expense",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "21a4bf6b-83b3-8121-ab92-f1814a4e6e69",
          "mode": "list",
          "cachedResultName": "Incomes",
          "cachedResultUrl": "https://www.notion.so/21a4bf6b83b38121ab92f1814a4e6e69"
        },
        "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Title', ``, 'string') }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Amount|number",
              "numberValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues0_Number', ``, 'number') }}"
            },
            {
              "key": "Date|date",
              "includeTime": false,
              "date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues1_Date', ``, 'string') }}",
              "timezone": "Europe/Brussels"
            },
            {
              "key": "Source|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues2_relationValue0_Relation_IDs', ``, 'string') }}"
              ]
            },
            {
              "key": "Accounts|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues3_relationValue0_Relation_IDs', ``, 'string') }}"
              ]
            },
            {
              "key": "Analytics|status",
              "statusValue": "={{ $fromAI('propertyValues4_Select', 'Can be Include In Analytics or Exclude From Analytics', 'string', 'Include In Analytics') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        1776,
        2016
      ],
      "id": "ef39d1a3-682b-4f2b-8558-f5ff14380a0d",
      "name": "Add Income",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "21a4bf6b-83b3-80d4-a7b3-f51fe09d2f65",
          "mode": "list",
          "cachedResultName": "Accounts",
          "cachedResultUrl": "https://www.notion.so/21a4bf6b83b380d4a7b3f51fe09d2f65"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        672,
        2016
      ],
      "id": "edb6282a-b6be-4970-8a19-d090caacc01f",
      "name": "Get All Accounts",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "21a4bf6b-83b3-8104-ab15-dab184680139",
          "mode": "list",
          "cachedResultName": "Sources",
          "cachedResultUrl": "https://www.notion.so/21a4bf6b83b38104ab15dab184680139"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        960,
        2016
      ],
      "id": "7016316f-e0d2-47d5-863c-0795d4ee1a7c",
      "name": "Get All Sources",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "21a4bf6b-83b3-81ef-9ebd-e00bdedc4cb6",
          "mode": "list",
          "cachedResultName": "Budgets",
          "cachedResultUrl": "https://www.notion.so/21a4bf6b83b381ef9ebde00bdedc4cb6"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        816,
        2016
      ],
      "id": "48943062-8fde-4b9a-9c7a-6ab43ae0abef",
      "name": "Get All Categories",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Use this tool to update budget pages properties.",
        "resource": "databasePage",
        "operation": "update",
        "pageId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Database_Page', ``, 'string') }}",
          "__regex": "^([0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12})"
        },
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "=Name|title",
              "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues0_Title', `Name of the category. Keep it to previous value if no specific request regarding its value has been provided (string).`, 'string') }}"
            },
            {
              "key": "=This Month Budget|number",
              "numberValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues1_Number', `Must never be empty unless specifically requested by the user. Keep it to previous value if no specific request regarding its value has been provided (number).`, 'number') }}"
            },
            {
              "key": "=Accounts|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues2_relationValue0_Relation_IDs', ``, 'string') }}"
              ]
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        3216,
        2016
      ],
      "id": "1507d9a0-7673-4742-9306-7761117b5adf",
      "name": "Update Category",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "21a4bf6b-83b3-81e5-b366-ebd4a5b6b682",
          "mode": "list",
          "cachedResultName": "Expenses",
          "cachedResultUrl": "https://www.notion.so/21a4bf6b83b381e5b366ebd4a5b6b682"
        },
        "returnAll": true,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "key": "Date|date",
              "condition": "=on_or_after",
              "date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Date', `The start date for the filter. For a range, this is the first day.`, 'string') }}"
            },
            {
              "key": "Date|date",
              "condition": "=on_or_before",
              "date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions1_Date', `The end date for the filter. For a range, this is the last day.`, 'string') }}"
            }
          ]
        },
        "options": {
          "sort": {
            "sortValue": [
              {
                "key": "Date|date",
                "direction": "descending"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        1248,
        2016
      ],
      "id": "7caa3760-33ff-427c-bca5-04ea7eb7f02d",
      "name": "Get Expenses",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "21a4bf6b-83b3-8121-ab92-f1814a4e6e69",
          "mode": "list",
          "cachedResultName": "Incomes",
          "cachedResultUrl": "https://www.notion.so/21a4bf6b83b38121ab92f1814a4e6e69"
        },
        "returnAll": true,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "key": "Date|date",
              "condition": "on_or_after",
              "date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Date', `The start date for the filter. For a range, this is the first day.`, 'string') }}"
            },
            {
              "key": "Date|date",
              "condition": "on_or_before",
              "date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions1_Date', `The end date for the filter. For a range, this is the last day.`, 'string') }}"
            }
          ]
        },
        "options": {
          "sort": {
            "sortValue": [
              {
                "key": "Date|date",
                "direction": "descending"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        1392,
        2016
      ],
      "id": "d76ca4d9-8b7b-46c6-ab4a-8dfdef849a0d",
      "name": "Get Incomes",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": {
          "__rl": true,
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Database_Page', ``, 'string') }}",
          "mode": "id"
        },
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "=Accounts|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues0_relationValue0_Relation_IDs', ``, 'string') }}"
              ]
            },
            {
              "key": "=Amount|number",
              "numberValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues1_Number', ``, 'number') }}"
            },
            {
              "key": "=Category|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues2_relationValue0_Relation_IDs', ``, 'string') }}"
              ]
            },
            {
              "key": "=Date|date",
              "includeTime": false,
              "date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues3_Date', ``, 'string') }}",
              "timezone": "=default"
            },
            {
              "key": "=Type|select",
              "selectValue": "={{ $fromAI('propertyValues4_Select', 'Can be Single for single transaction, Every 3 Months or Every 1 Month, for recurring transactions. If another recurring type is requested output that it is not in your abilities', 'string') }}"
            },
            {
              "key": "=Analytics|status",
              "statusValue": "={{ $fromAI('propertyValues5_Select', 'Must not be empty. Can be Include In Analytics or Exclude From Analytics', 'string', 'Include In Analytics') }}"
            },
            {
              "key": "=Name|title",
              "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues6_Title', `Name of the entry. Keep it to previous value if no specific request regarding its value has been provided (string).`, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        2640,
        2016
      ],
      "id": "82c50eea-ad69-4fcb-8d2c-16d8cd571c09",
      "name": "Update Expense",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": {
          "__rl": true,
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Database_Page', ``, 'string') }}",
          "mode": "id"
        },
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "=Accounts|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues0_relationValue0_Relation_IDs', ``, 'string') }}"
              ]
            },
            {
              "key": "=Amount|number",
              "numberValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues1_Number', ``, 'number') }}"
            },
            {
              "key": "=Date|date",
              "includeTime": false,
              "date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues2_Date', ``, 'string') }}",
              "timezone": "=default"
            },
            {
              "key": "=Name|title",
              "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues3_Title', ``, 'string') }}"
            },
            {
              "key": "=Source|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues4_relationValue0_Relation_IDs', ``, 'string') }}"
              ]
            },
            {
              "key": "=Analytics|status",
              "statusValue": "={{ $fromAI('propertyValues5_Select', 'Must not be empty. Can be Include In Analytics or Exclude From Analytics', 'string', 'Include In Analytics') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        2784,
        2016
      ],
      "id": "dc5ac070-e80a-493a-aa8d-ad47de6faffc",
      "name": "Update Income",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "21b4bf6b-83b3-80b8-a632-c7e3904c655c",
          "mode": "list",
          "cachedResultName": "Transfers",
          "cachedResultUrl": "https://www.notion.so/21b4bf6b83b380b8a632c7e3904c655c"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        1104,
        2016
      ],
      "id": "ccc2b656-51cf-4b9e-9d66-0c373b8fe2e9",
      "name": "Get All Transfers",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": {
          "__rl": true,
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Database_Page', ``, 'string') }}",
          "mode": "id"
        },
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "=Sender|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues0_relationValue0_Relation_IDs', `Must never be empty. This represents the account ID (string)`, 'string') }}"
              ]
            },
            {
              "key": "=Amount To Transfer|number",
              "numberValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues1_Number', ``, 'number') }}"
            },
            {
              "key": "=Transfer Date|date",
              "includeTime": false,
              "date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues3_Date', ``, 'string') }}",
              "timezone": "=default"
            },
            {
              "key": "=Name|title",
              "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues6_Title', `Name of the entry. Keep it to previous value if no specific request regarding its value has been provided (string).`, 'string') }}"
            },
            {
              "key": "=Receiver|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues4_relationValue0_Relation_IDs', `Must never be empty. This represents the account ID (string)`, 'string') }}"
              ]
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        2928,
        2016
      ],
      "id": "32be8cf5-6479-49cd-9340-87df9b89fcea",
      "name": "Update Transfer",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d2c77348-8471-4d09-be0b-54cd378c7853",
              "name": "input_text",
              "value": "={{ $json.message.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -384,
        624
      ],
      "id": "54b5244e-7bc7-4858-b18e-c9a43e650fde",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "34129220-59a1-4288-b732-c6887a944b31",
              "name": "input_text",
              "value": "=Extracted from audio:\n{{ $json.candidates[0].content.parts[0].text }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "include": "selected",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -384,
        208
      ],
      "id": "43a78d97-3f80-4254-8e4b-bbc217fd373f",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "34129220-59a1-4288-b732-c6887a944b31",
              "name": "input_text",
              "value": "=Extracted from image:\n{{ $json.candidates[0].content.parts[0].text }}\n\nCAPTION ADDED BY THE USER: {{ $('Telegram Trigger').item.json.message.caption || 'No caption provided' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -384,
        400
      ],
      "id": "f027362c-a052-453b-92b5-324436ea880d",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "21a4bf6b-83b3-81ef-9ebd-e00bdedc4cb6",
          "mode": "list",
          "cachedResultName": "Budgets",
          "cachedResultUrl": "https://www.notion.so/21a4bf6b83b381ef9ebde00bdedc4cb6"
        },
        "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Title', `Name of the budget category.`, 'string') }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "=Accounts|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues0_relationValue0_Relation_IDs', `Must never be empty. The default account is the Main account. This represents the account ID (string).`, 'string') }}"
              ]
            },
            {
              "key": "=This Month Budget|number",
              "numberValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues1_Number', `Budget value of the current month. put the value to cover expenses. if no value, leave it empty.`, 'number') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        2240,
        2016
      ],
      "id": "7515ef0b-9e01-4c1f-b85d-b30780d035d0",
      "name": "Create New Category",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "21a4bf6b-83b3-8104-ab15-dab184680139",
          "mode": "list",
          "cachedResultName": "Sources",
          "cachedResultUrl": "https://www.notion.so/21a4bf6b83b38104ab15dab184680139"
        },
        "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Title', `Name of the source.`, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        2384,
        2016
      ],
      "id": "9676c483-5e15-4c6f-a4f2-cf57f65d9547",
      "name": "Create New Source",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Use this tool to update source pages properties.",
        "resource": "databasePage",
        "operation": "update",
        "pageId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Database_Page', ``, 'string') }}",
          "__regex": "^([0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12})"
        },
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "=Name|title",
              "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues0_Title', `Name of the source. Keep it to previous value if no specific request regarding its value has been provided (string).`, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        3360,
        2016
      ],
      "id": "618a1e2b-ea0f-41e9-b5a0-015acbdd13ea",
      "name": "Update Source",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "This agent is responsible for creating and updating database items. It extracts all necessary information from the user's prompt and can ask for clarification if details are missing.",
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', `Isolated prompt for the agent from the manager AI agent working for the user.`, 'string') }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=You are the Ledger Agent, a specialized, autonomous transaction management tool for the Manager Agent. You are an expert in the process of creating and updating single transactions and their related entities (categories, sources, accounts). You communicate EXCLUSIVELY with the Manager Agent.\n\n## CORE DIRECTIVE: AUTONOMOUS TRANSACTION PROCESSING\nYou are expected to independently manage the entire lifecycle of a transaction request. Given a simple instruction like \"The user bought a coffee for 3.50,\" you must execute the full sequence of fetching, validating, potentially creating entities, and logging the final transaction. This also includes special requests like balance adjustments.\n\n## CRITICAL FAILURE PROTOCOL: NO DATA, NO GUESSING\nYour primary safeguard is to **never invent data**.\n- When you call data-fetching tools like `Get_All_Accounts`, `Get_All_Categories`, or `Get_All_Sources`, if a tool returns an error or an empty list, you MUST try again several times.\n- If all attempts fail for any required entity list, you MUST immediately halt all processing.\n- You will then return a single, specific failure report to the Manager: `OPERATION FAILED: Could not retrieve necessary entity lists (e.g., Accounts, Categories) from the database.`\n- **Under no circumstances** should you proceed to log the transaction if you cannot factually resolve the required IDs. Inventing IDs is a critical failure.\n\n## CRITICAL DATA INTEGRITY PROTOCOL: ALL TRANSACTIONS MUST BE COMPLETE\n- For any standard (non-balance-adjustment) transaction, the `Account ID` is **MANDATORY**. If you cannot resolve an Account from the user's request or a default, you **MUST HALT** and report a failure: `OPERATION FAILED: Incomplete transaction data. The Account could not be resolved.`\n- The `Category ID` (for expenses) or `Source ID` (for incomes) are also **MANDATORY**. However, if the user does not specify one, you **MUST NOT fail**. Instead, you **MUST default to using the category or source named \"Other.\"**\n- If an entity named \"Other\" does not exist, your protocol is to **create it** and use its new ID.\n- A transaction with an empty relation field is an incomplete transaction and is forbidden.\n\n## DATABASE FIELD PROPERTIES\nWhen creating an expense or income, you must only provide values for the following **modifiable fields**:\n- `Name` (Text) - For balance adjustments, this must be set to the exact string 'Balance Adjustment'.\n- `Amount` (Number)\n- `Date` (Date)\n- `Account` (Relation)\n- `Category` or `Source` (Relation) - **CRITICAL: For standard transactions, this MUST be populated, defaulting to 'Other' if not specified.** For balance adjustments, these should be left empty.\n- `Type` (Select) - **CRITICAL: When adding a one-time expense or income, this field MUST be set to the exact string value 'Single'.**\n- `Analytics` (Select) - **CRITICAL: For balance adjustments, this MUST be set to the exact string value 'Exclude From Analytics'. For all other transactions, this field should not be included.**\n\nThe following fields are **unmodifiable formulas** and will be calculated automatically by the database. **DO NOT attempt to set them**:\n- `Transaction Status` (This is automatically calculated based on the `Date`. A past or current date results in 'âœ“ Logged', a future date results in 'ðŸ—“ï¸ Scheduled')\n- `Record Value` / `Schedule Value`\n- `Expense Value`\n- `Created time` / `Last edited time`\n\n## ALWAYS THINK FIRST\nYour first action for any request is **MANDATORY**: you must use the `Think` tool to create a step-by-step execution plan. Your thought process must:\n1.  **Deconstruct the Goal:** Analyze the Manager's request to extract all provided data points (`item_name`, `amount`, `date`, `account_name`, `category_name`/`source_name`, etc.).\n2.  **Plan Entity Resolution:** Outline your plan to get the necessary Notion Page IDs. This involves parallel calls to `Get_All_Accounts` and `Get_All_Categories`/`Get_All_Sources`. Note the retry-and-fail protocol.\n3.  **Create Contingency Plan:** State your logic for handling entities. Example: \"If the user specifies a category, I will search for it and create it if it doesn't exist. If the user does *not* specify a category, I will search for 'Other'. If 'Other' does not exist, I will create it and use its ID.\"\n4.  **Final Action Plan:** List the final tool call (`Add_Expense` or `Add_Income`) that will complete the task, confirming that all required IDs will be provided.\n\n## STANDARD OPERATING PROCEDURE (SOP): LOG TRANSACTION\n1.  **Think:** Create the execution plan as described above.\n2.  **Entity Resolution (Parallel Calls):** Call `Get_All_Accounts` and `Get_All_Categories`/`Get_All_Sources` to find the required Notion Page IDs. *(Adhere to the Critical Failure Protocol)*.\n3.  **Entity Handling and Defaulting (Internal Logic):**\n    -   **Account:** Resolve the `Account ID`. If you cannot find or create a valid Account ID based on the user's request or the default, halt and report the `Incomplete transaction data` failure.\n    -   **Category/Source:**\n        -   If the user **provided** a category or source name: Search the retrieved list for a match. If no match is found, call `Create_New_Category`/`Create_New_Source` with the user's provided name and use the new ID.\n        -   If the user did **NOT** provide a category or source name: Search the retrieved list for an entity named exactly \"Other\". If found, use its ID. If not found, call `Create_New_Category`/`Create_New_Source` with the name \"Other\" and use the new ID.\n4.  **Mandatory ID Validation:** Before proceeding, you MUST verify internally that you have successfully resolved a non-empty value for the `Account ID` AND the `Category ID` (for expenses) or `Source ID` (for incomes).\n5.  **Transaction Creation/Update:** If validation passes, use the `Calculator` to ensure the amount is correct (negative for expenses, positive for incomes). Call the appropriate tool (`Add_Expense`, `Add_Income`).\n    - For a **Balance Adjustment**, you will set the `Name` to 'Balance Adjustment' and `Analytics` to 'Exclude From Analytics', leaving Category/Source blank.\n    - For a **standard transaction**, you will use the user-provided name and all resolved IDs.\n6.  **Structured Confirmation:** Assemble a report using the `OPERATION COMPLETE` format, explicitly noting any new entities created. If the process fails at any step, use the specified failure report format.\n\n## STRICT LIMITATIONS\n- You only handle single, non-recurring transactions. You CANNOT process transfers, schedule recurring transactions, or perform data analysis.\n- You report only to the Manager Agent.\n\n## CONTEXTUAL INFO\n- Current date: {{ $now }}\n- Default currency: Euro (â‚¬)\n- Default account: Main\n\n---\n## AVAILABLE TOOLS\nHere is a comprehensive list of available tools. You must adhere to the specified parameters.\n\n### **General Purpose Tools**\n*   **`Think`**\n    *   **Description:** Used to plan your actions before execution.\n    *   **Parameters:**\n        *   `plan` (string, required): A step-by-step plan of the tools you will use.\n*   **`Calculator`**\n    *   **Description:** Use this tool to perform mathematical calculations.\n\n### **Data Retrieval Tools**\n*   **`Get_All_Accounts`**\n    *   **Description:** Retrieves a list of all financial accounts and their Notion page IDs. This tool has no filtering capabilities.\n*   **`Get_All_Categories`**\n    *   **Description:** Retrieves a list of all expense categories and their Notion page IDs. This tool has no filtering capabilities.\n*   **`Get_All_Sources`**\n    *   **Description:** Retrieves a list of all income sources and their Notion page IDs. This tool has no filtering capabilities.\n*   **`Get_Expenses`**\n    *   **Description:** Retrieves a list of expenses, with a mandatory date filter.\n    *   **Parameters:**\n        *   `filter` (object, required):\n            *   `Date` (date, required): The transaction date. Supported conditions: `on_or_after`, `on_or_before`.\n*   **`Get_Incomes`**\n    *   **Description:** Retrieves a list of incomes, with a mandatory date filter.\n    *   **Parameters:**\n        *   `filter` (object, required):\n            *   `Date` (date, required): The transaction date. Supported conditions: `on_or_after`, `on_or_before`.\n\n### **Data Creation Tools**\n*   **`Add_Expense`**\n    *   **Description:** Creates a new single expense record in the database.\n    *   **Parameters:**\n        *   `Name` (string, required): The name of the expense.\n        *   `Amount` (number, required): The numerical amount of the expense.\n        *   `Date` (date, required): The date of the expense.\n        *   `Account ID` (string, required): The Notion page ID for the source account.\n        *   `Category ID` (string, required): The Notion page ID for the expense category. This field is mandatory.\n        *   `Type` (string, required): The transaction type. Must be set to `'Single'`.\n        *   `Analytics` (string, optional): The analytics status. Must be `'Exclude From Analytics'` for balance adjustments.\n*   **`Add_Income`**\n    *   **Description:** Creates a new single income record in the database.\n    *   **Parameters:**\n        *   `Name` (string, required): The name of the income.\n        *   `Amount` (number, required): The numerical amount of the income.\n        *   `Date` (date, required): The date of the income.\n        *   `Account ID` (string, required): The Notion page ID for the destination account.\n        *   `Source ID` (string, required): The Notion page ID for the income source. This field is mandatory.\n        *   `Analytics` (string, optional): The analytics status. Must be `'Exclude From Analytics'` for balance adjustments.\n*   **`Create_New_Account`**\n    *   **Description:** Creates a new financial account.\n    *   **Parameters:**\n        *   `Name` (string, required): The name of the new account.\n        *   `Account Type` (string, required): The type of the account.\n        *   `Balance init` (number, required): The initial balance, which must be 0.\n*   **`Create_New_Category`**\n    *   **Description:** Creates a new expense category (budget).\n    *   **Parameters:**\n        *   `Name` (string, required): The name of the new category.\n        *   `Account ID` (string, required): The Notion page ID of the default account for this category.\n        *   `This Month Budget` (number, optional): The budget amount for the current month.\n*   **`Create_New_Source`**\n    *   **Description:** Creates a new income source.\n    *   **Parameters:**\n        *   `Name` (string, required): The name of the new source.\n\n### **Data Modification Tools**\n*   **`Update_Account`**\n    *   **Description:** Updates an existing financial account.\n    *   **Parameters:**\n        *   `Page ID` (string, required): The Notion page ID of the account to update.\n        *   `Name` (string, optional): The updated name of the account.\n*   **`Update_Category`**\n    *   **Description:** Updates an existing expense category (budget).\n    *   **Parameters:**\n        *   `Page ID` (string, required): The Notion page ID of the category to update.\n        *   `Name` (string, optional): The updated name of the category.\n        *   `This Month Budget` (number, optional): The updated budget amount.\n        *   `Account ID` (string, optional): The updated Notion page ID for the default account.\n*   **`Update_Source`**\n    *   **Description:** Updates an existing income source.\n    *   **Parameters:**\n        *   `Page ID` (string, required): The Notion page ID of the source to update.\n        *   `Name` (string, optional): The updated name of the source.\n*   **`Update_Expense`**\n    *   **Description:** Updates an existing expense record.\n    *   **Parameters:**\n        *   `Page ID` (string, required): The Notion page ID of the expense to update.\n        *   `Name` (string, optional): The updated name.\n        *   `Amount` (number, optional): The updated amount.\n        *   `Date` (date, optional): The updated date.\n        *   `Account ID` (string, optional): The updated account relation ID.\n        *   `Category ID` (string, optional): The updated category relation ID.\n        *   `Type` (string, optional): The updated type.\n        *   `Analytics` (string, optional): The updated analytics status.\n*   **`Update_Income`**\n    *   **Description:** Updates an existing income record.\n    *   **Parameters:**\n        *   `Page ID` (string, required): The Notion page ID of the income to update.\n        *   `Name` (string, optional): The updated name.\n        *   `Amount` (number, optional): The updated amount.\n        *   `Date` (date, optional): The updated date.\n        *   `Account ID` (string, optional): The updated account relation ID.\n        *   `Source ID` (string, optional): The updated source relation ID.\n        *   `Analytics` (string, optional): The updated analytics status.\n\nRemember: You are a transaction tool. Always start by thinking and planning. Your job is to correctly set the modifiable fields for a single entry; the database will handle the formula calculations automatically.\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        2400,
        848
      ],
      "id": "ab69ec0a-2253-4d44-97af-f088f11b5f7e",
      "name": "Ledger Agent"
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "21a4bf6b-83b3-80d4-a7b3-f51fe09d2f65",
          "mode": "list",
          "cachedResultName": "Accounts",
          "cachedResultUrl": "https://www.notion.so/21a4bf6b83b380d4a7b3f51fe09d2f65"
        },
        "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Title', `Name of the account`, 'string') }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Account Type|select",
              "selectValue": "={{ $fromAI('propertyValues0_Select', 'Can be Current Account or Saving Account depending of the purpose of the request', 'string', 'Current Account') }}"
            },
            {
              "key": "Balance init|number",
              "numberValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues1_Number', `Upon new creation, must always be 0`, 'number') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        2096,
        2016
      ],
      "id": "b8e29dec-79bf-4ef3-8125-2ff3cc990976",
      "name": "Create New Account",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": {
          "__rl": true,
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Database_Page', ``, 'string') }}",
          "mode": "id"
        },
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "=Name|title",
              "title": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues0_Title', `Name of the account. Keep it to previous value if no specific request regarding its value has been provided (string).`, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        3072,
        2016
      ],
      "id": "a239ecad-034d-45d1-83c8-3dc855ef937e",
      "name": "Update Account",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "21b4bf6b83b380b8a632c7e3904c655c",
          "mode": "list",
          "cachedResultName": "Transfers"
        },
        "title": "={{ `New Transfer - ${$now.toFormat('yyyy-MM-dd HH:mm')}` }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Amount To Transfer|number",
              "numberValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('amount', ``, 'number') }}"
            },
            {
              "key": "Sender|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues1_relationValue0_Relation_IDs', `Notion Page ID (string) for the sender account.`, 'string') }}"
              ]
            },
            {
              "key": "Receiver|relation",
              "relationValue": [
                "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues2_relationValue0_Relation_IDs', `Notion Page ID (string) for the receiver account.`, 'string') }}"
              ]
            },
            {
              "key": "Transfer Date|date",
              "date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('propertyValues3_Date', `Date and time of the transfer. The default date and time is the current one (now), if none is provided. For this property field, You MUST provide the time too, not only the date.`, 'string') }}",
              "timezone": "Europe/Brussels"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notionTool",
      "typeVersion": 2.2,
      "position": [
        1920,
        2016
      ],
      "id": "ddf5832c-568f-4040-8427-d607a10cf495",
      "name": "Add a Transfer entry",
      "credentials": {
        "notionApi": {
          "id": "xhPFZolX6B78T2VZ",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "=models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -32,
        2016
      ],
      "id": "fe4c80c3-5b85-45b1-bf1f-7f13dd05795e",
      "name": "gemini-2.5-pro2",
      "credentials": {
        "googlePalmApi": {
          "id": "CTf2VqOHGTu2mfy7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "model": "=x-ai/grok-4-fast:free",
        "options": {
          "maxRetries": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -672,
        2016
      ],
      "id": "dbc88e84-d576-4a9b-8fbf-85cd92bc9c37",
      "name": "grok-4-fast2",
      "credentials": {
        "openRouterApi": {
          "id": "ZKTJgDKo5oXOolBu",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "=models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        112,
        2016
      ],
      "id": "8af388df-307c-49fd-9097-69d4c3a15423",
      "name": "gemini-2.5-pro3",
      "credentials": {
        "googlePalmApi": {
          "id": "CTf2VqOHGTu2mfy7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "model": "=x-ai/grok-4-fast:free",
        "options": {
          "maxRetries": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -560,
        2016
      ],
      "id": "523d2fa6-82ce-4e75-b206-ff1219da5cc0",
      "name": "grok-4-fast3",
      "credentials": {
        "openRouterApi": {
          "id": "ZKTJgDKo5oXOolBu",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "=models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        256,
        2016
      ],
      "id": "1e90107a-587b-4fa4-bea5-e18dc6c9b757",
      "name": "gemini-2.5-pro4",
      "credentials": {
        "googlePalmApi": {
          "id": "CTf2VqOHGTu2mfy7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "model": "=x-ai/grok-4-fast:free",
        "options": {
          "maxRetries": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -448,
        2016
      ],
      "id": "68bf45d6-b100-4534-ae0a-6f47fe8d4361",
      "name": "grok-4-fast4",
      "credentials": {
        "openRouterApi": {
          "id": "ZKTJgDKo5oXOolBu",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "model": "=x-ai/grok-4-fast:free",
        "options": {
          "maxRetries": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -336,
        2016
      ],
      "id": "bf69cda7-21e1-48a9-b625-9bbf058c5dbe",
      "name": "grok-4-fast5",
      "credentials": {
        "openRouterApi": {
          "id": "ZKTJgDKo5oXOolBu",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "=models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        400,
        2016
      ],
      "id": "a3f52fb9-8b8e-4066-8b9c-1a699e1ad6b0",
      "name": "gemini-2.5-pro5",
      "credentials": {
        "googlePalmApi": {
          "id": "CTf2VqOHGTu2mfy7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        4864,
        2032
      ],
      "id": "b4504676-4fd2-4cb3-8e30-8548055b775c",
      "name": "Think5"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.chat.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4320,
        2032
      ],
      "id": "f0179ec0-d8d8-46c5-89e7-ffe09f601a86",
      "name": "Simple Memory5",
      "disabled": true
    },
    {
      "parameters": {
        "toolDescription": "=Call this AI agent when needed to make an Internet research.",
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', `Isolated prompt for the agent from the manager AI agent working for the user.`, 'string') }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=You are the Internet Research Agent, a specialized, autonomous research tool for the Manager Agent. You are an expert at interpreting the Manager's request, formulating precise search queries, executing web searches, and synthesizing the results into a single, factual answer. You communicate EXCLUSIVELY with the Manager Agent.\n\n## CORE DIRECTIVE: AUTONOMOUS RESEARCH\nYou are expected to independently manage the entire research lifecycle. Given an abstract goal like \"Find the price of this item,\" you must create and execute a plan to search the internet, validate sources, and return a definitive, sourced answer.\n\n## CRITICAL FAILURE PROTOCOL: NO FABRICATION\nYour primary safeguard is to **never invent, guess, or infer an answer**.\n- If your search tool returns an error or no relevant results, you MUST try again with a rephrased query.\n- If multiple attempts fail to yield a reliable answer, you MUST immediately halt all processing.\n- You will then return a single, specific failure report to the Manager: `RESEARCH FAILED: No definitive answer could be found online for the query.`\n- **Under no circumstances** should you provide an answer from an unreliable source or a \"best guess.\" Providing unverified information is a critical failure.\n\n## ALWAYS THINK FIRST\nYour first action for any request is **MANDATORY**: you must use the `Think` tool to create a step-by-step execution plan. Your thought process must:\n1.  **Deconstruct the Goal:** Analyze the Manager's request to identify the core question (e.g., \"What is the price of X?\", \"What are the opening hours for Y?\", \"Who is Z?\").\n2.  **Formulate the Optimal Query:** Construct a precise and localized search query. You must combine the core question with the provided contextual information (especially the user's location) to get the most relevant results. For example, \"price of Leffe Ruby\" should become \"price Leffe Ruby 33cl Brussels\".\n3.  **Define Success Criteria:** State what a reliable answer looks like. For product prices, this would be a major local retailer. For business hours, it would be the official website or Google Business Profile. For facts, it would be a reputable news source or encyclopedia.\n4.  **Final Action Plan:** List the final action, which is to call the `Tavily_Search` tool and then synthesize the results into the `RESEARCH COMPLETE` format.\n\n## STANDARD OPERATING PROCEDURE (SOP): CONDUCT RESEARCH\n1.  **Think:** Create the execution plan as described above.\n2.  **Execute Search:** Call the `Tavily_Search` tool with the optimized query. *(Adhere to the Critical Failure Protocol at each step)*.\n3.  **Analyze & Synthesize Results:**\n    -   Review the top 3-5 search results.\n    -   Identify the most reliable source based on your predefined success criteria.\n    -   Extract the single, direct answer to the Manager's question from that source. Do not provide extraneous details.\n4.  **Structured Response:**\n    -   If successful, assemble a report in the `RESEARCH COMPLETE` format.\n    -   If unsuccessful after multiple attempts, return the standard `RESEARCH FAILED` report.\n\n## RESPONSE FORMATS\n- **Success Report:** `RESEARCH COMPLETE\\nANSWER: [The single, concise answer to the question.]\\nSOURCE: [The URL of the most reliable source.]`\n- **Failure Report:** `RESEARCH FAILED: No definitive answer could be found online for the query.`\n\n## STRICT LIMITATIONS\n- You only perform internet searches. You CANNOT access the user's financial database, log transactions, or perform any capabilities of the other agents.\n- You do not have a memory of past searches. Each request is a new task.\n- You report only to the Manager Agent.\n\n## CONTEXTUAL INFO\n- Current date: {{ $now }}\n- Default currency: Euro (â‚¬)\n\nRemember: You are a factual research tool. Always start by thinking and planning. Your job is to find a single, reliable, and sourced answer to the Manager's question, and to report failure clearly if one cannot be found."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        3344,
        848
      ],
      "id": "30e882c6-0c81-4d9b-b70e-671330be4bc7",
      "name": "Internet Research Agent"
    },
    {
      "parameters": {
        "query": "={{ $fromAI('Query', ``, 'string') }}",
        "options": {
          "topic": "general",
          "search_depth": "advanced",
          "chunks_per_source": 3,
          "max_results": 10,
          "time_range": "year",
          "include_answer": "advanced",
          "country": "={{ $fromAI('Country', ``, 'string') }}"
        }
      },
      "type": "@tavily/n8n-nodes-tavily.tavilyTool",
      "typeVersion": 1,
      "position": [
        3504,
        2016
      ],
      "id": "85195139-16e1-4309-a828-4209ce5b5d65",
      "name": "Search in Tavily",
      "credentials": {
        "tavilyApi": {
          "id": "UdRm3ltER2RlpmUn",
          "name": "Tavily account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Switch Input Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Input Type": {
      "main": [
        [
          {
            "node": "Get Voice File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Photo File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Voice File": {
      "main": [
        [
          {
            "node": "Transcribe Recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Recording": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Photo File": {
      "main": [
        [
          {
            "node": "Analyze Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Image": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Data Analyst Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Transfer Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Think1": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory2": {
      "ai_memory": [
        [
          {
            "node": "Data Analyst Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Think2": {
      "ai_tool": [
        [
          {
            "node": "Data Analyst Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Data Analyst Agent": {
      "ai_tool": [
        [
          {
            "node": "The Manager Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory3": {
      "ai_memory": [
        [
          {
            "node": "Transfer Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Think3": {
      "ai_tool": [
        [
          {
            "node": "Transfer Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Transfer Agent": {
      "ai_tool": [
        [
          {
            "node": "The Manager Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory4": {
      "ai_memory": [
        [
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Think4": {
      "ai_tool": [
        [
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Recurring Transaction Agent": {
      "ai_tool": [
        [
          {
            "node": "The Manager Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "The Manager Agent": {
      "main": [
        [
          {
            "node": "Send Success Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "grok-4-fast": {
      "ai_languageModel": [
        [
          {
            "node": "The Manager Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gemini-2.5-pro": {
      "ai_languageModel": [
        [
          {
            "node": "The Manager Agent",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "The Manager Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "grok-4-fast1": {
      "ai_languageModel": [
        [
          {
            "node": "Data Analyst Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gemini-2.5-pro1": {
      "ai_languageModel": [
        [
          {
            "node": "Data Analyst Agent",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "The Manager Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Add Expense": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Add Income": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update Category": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get All Accounts": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Transfer Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Data Analyst Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get All Sources": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Data Analyst Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get All Categories": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Data Analyst Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get Expenses": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Data Analyst Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get Incomes": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Data Analyst Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update Expense": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update Income": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get All Transfers": {
      "ai_tool": [
        [
          {
            "node": "Transfer Agent",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Data Analyst Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update Transfer": {
      "ai_tool": [
        [
          {
            "node": "Transfer Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "The Manager Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "The Manager Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "The Manager Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New Category": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create New Source": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update Source": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Ledger Agent": {
      "ai_tool": [
        [
          {
            "node": "The Manager Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create New Account": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update Account": {
      "ai_tool": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Add a Transfer entry": {
      "ai_tool": [
        [
          {
            "node": "Transfer Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "grok-4-fast2": {
      "ai_languageModel": [
        [
          {
            "node": "Transfer Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gemini-2.5-pro2": {
      "ai_languageModel": [
        [
          {
            "node": "Transfer Agent",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "grok-4-fast3": {
      "ai_languageModel": [
        [
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gemini-2.5-pro3": {
      "ai_languageModel": [
        [
          {
            "node": "Recurring Transaction Agent",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "grok-4-fast4": {
      "ai_languageModel": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gemini-2.5-pro4": {
      "ai_languageModel": [
        [
          {
            "node": "Ledger Agent",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Simple Memory5": {
      "ai_memory": [
        [
          {
            "node": "Internet Research Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Think5": {
      "ai_tool": [
        [
          {
            "node": "Internet Research Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "grok-4-fast5": {
      "ai_languageModel": [
        [
          {
            "node": "Internet Research Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gemini-2.5-pro5": {
      "ai_languageModel": [
        [
          {
            "node": "Internet Research Agent",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Internet Research Agent": {
      "ai_tool": [
        [
          {
            "node": "The Manager Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Search in Tavily": {
      "ai_tool": [
        [
          {
            "node": "Internet Research Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "BdPZPAcsRgUSMBIk",
    "timeSavedPerExecution": 0
  },
  "versionId": "64b1eea2-8099-4aec-9186-b61e9fbb3d10",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f6b23180a40ad9c1f19233919060eb2036225d0ebab77c0e6d7346fdfd5470bc"
  },
  "id": "LpQjYsjwwZ104lBc",
  "tags": []
}